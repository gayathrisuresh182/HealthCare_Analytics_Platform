name: dbt CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  dbt-test:
    name: dbt Test & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-snowflake
        pip install -r scripts/requirements.txt
    
    - name: Install dbt packages
      run: dbt deps
      env:
        DBT_PROFILES_DIR: ~/.dbt
    
    - name: Create profiles.yml
      run: |
        mkdir -p ~/.dbt
        # Create profiles.yml directly with secrets (more reliable than sed)
        cat > ~/.dbt/profiles.yml << EOF
        healthcare_analytics:
          target: dev
          outputs:
            dev:
              type: snowflake
              account: "${{ secrets.SNOWFLAKE_ACCOUNT }}"
              user: "${{ secrets.SNOWFLAKE_USER }}"
              password: "${{ secrets.SNOWFLAKE_PASSWORD }}"
              role: "${{ secrets.SNOWFLAKE_ROLE }}"
              database: "${{ secrets.SNOWFLAKE_DATABASE }}"
              warehouse: "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
              schema: raw
              threads: 4
              client_session_keep_alive: false
              query_tag: healthcare_analytics_dev
            prod:
              type: snowflake
              account: "${{ secrets.SNOWFLAKE_ACCOUNT }}"
              user: "${{ secrets.SNOWFLAKE_USER }}"
              password: "${{ secrets.SNOWFLAKE_PASSWORD }}"
              role: "${{ secrets.SNOWFLAKE_ROLE }}"
              database: "${{ secrets.SNOWFLAKE_DATABASE }}"
              warehouse: "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
              schema: raw
              threads: 8
              client_session_keep_alive: false
              query_tag: healthcare_analytics_prod
        EOF
        # Verify file was created
        cat ~/.dbt/profiles.yml
    
    - name: Run dbt compile
      run: dbt compile
      env:
        DBT_PROFILES_DIR: ~/.dbt
    
    - name: Run dbt parse
      run: dbt parse
      env:
        DBT_PROFILES_DIR: ~/.dbt
    
    - name: Run dbt test (staging)
      run: dbt test --select staging
      env:
        DBT_PROFILES_DIR: ~/.dbt
    
    - name: Run dbt test (marts)
      run: dbt test --select marts
      env:
        DBT_PROFILES_DIR: ~/.dbt
      continue-on-error: false
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dbt-test-results
        path: target/
        if-no-files-found: warn

  dbt-run-dev:
    name: dbt Run (Dev Environment)
    runs-on: ubuntu-latest
    needs: dbt-test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-snowflake
        pip install -r scripts/requirements.txt
    
    - name: Install dbt packages
      run: dbt deps
    
    - name: Create profiles.yml (Dev)
      run: |
        mkdir -p ~/.dbt
        cat > ~/.dbt/profiles.yml << EOF
        healthcare_analytics:
          target: dev
          outputs:
            dev:
              type: snowflake
              account: "${{ secrets.SNOWFLAKE_ACCOUNT }}"
              user: "${{ secrets.SNOWFLAKE_USER }}"
              password: "${{ secrets.SNOWFLAKE_PASSWORD }}"
              role: "${{ secrets.SNOWFLAKE_ROLE }}"
              database: "${{ secrets.SNOWFLAKE_DATABASE }}"
              warehouse: "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
              schema: raw
              threads: 4
              client_session_keep_alive: false
              query_tag: healthcare_analytics_dev
        EOF
    
    - name: Run dbt (Dev)
      run: |
        dbt run --select staging --target dev
        dbt run --select intermediate --target dev
        dbt run --select marts --target dev
      env:
        DBT_PROFILES_DIR: ~/.dbt
    
    - name: Run Great Expectations
      run: |
        python scripts/gx_run_checkpoint.py
      env:
        DBT_PROFILES_DIR: ~/.dbt
      continue-on-error: true

  dbt-run-prod:
    name: dbt Run (Production)
    runs-on: ubuntu-latest
    needs: dbt-test
    if: github.ref == 'refs/heads/main'
    environment: production  # Requires manual approval
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-snowflake
        pip install -r scripts/requirements.txt
    
    - name: Install dbt packages
      run: dbt deps
    
    - name: Create profiles.yml (Prod)
      run: |
        mkdir -p ~/.dbt
        cat > ~/.dbt/profiles.yml << EOF
        healthcare_analytics:
          target: prod
          outputs:
            prod:
              type: snowflake
              account: "${{ secrets.SNOWFLAKE_ACCOUNT }}"
              user: "${{ secrets.SNOWFLAKE_USER }}"
              password: "${{ secrets.SNOWFLAKE_PASSWORD }}"
              role: "${{ secrets.SNOWFLAKE_ROLE }}"
              database: "${{ secrets.SNOWFLAKE_DATABASE }}"
              warehouse: "${{ secrets.SNOWFLAKE_WAREHOUSE }}"
              schema: raw
              threads: 8
              client_session_keep_alive: false
              query_tag: healthcare_analytics_prod
        EOF
    
    - name: Run dbt (Prod)
      run: |
        dbt run --select staging
        dbt run --select intermediate
        dbt run --select marts
      env:
        DBT_PROFILES_DIR: ~/.dbt
        DBT_TARGET: prod
    
    - name: Run Great Expectations
      run: |
        python scripts/gx_run_checkpoint.py
      env:
        DBT_PROFILES_DIR: ~/.dbt
      continue-on-error: true

