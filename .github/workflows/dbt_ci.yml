name: dbt CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  dbt-test:
    name: dbt Test & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-snowflake
        pip install -r scripts/requirements.txt
    
    - name: Install dbt packages
      run: dbt deps
      env:
        DBT_PROFILES_DIR: ./
    
    - name: Create profiles.yml
      run: |
        mkdir -p ~/.dbt
        cp profiles.yml.template ~/.dbt/profiles.yml
        # Replace placeholders with GitHub Secrets
        sed -i "s/{{SNOWFLAKE_ACCOUNT}}/${{ secrets.SNOWFLAKE_ACCOUNT }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_USER}}/${{ secrets.SNOWFLAKE_USER }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_PASSWORD}}/${{ secrets.SNOWFLAKE_PASSWORD }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_DATABASE}}/${{ secrets.SNOWFLAKE_DATABASE }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_WAREHOUSE}}/${{ secrets.SNOWFLAKE_WAREHOUSE }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_ROLE}}/${{ secrets.SNOWFLAKE_ROLE }}/g" ~/.dbt/profiles.yml
    
    - name: Run dbt compile
      run: dbt compile
      env:
        DBT_PROFILES_DIR: ./
    
    - name: Run dbt parse
      run: dbt parse
      env:
        DBT_PROFILES_DIR: ./
    
    - name: Run dbt test (staging)
      run: dbt test --select staging
      env:
        DBT_PROFILES_DIR: ./
    
    - name: Run dbt test (marts)
      run: dbt test --select marts
      env:
        DBT_PROFILES_DIR: ./
      continue-on-error: false
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: dbt-test-results
        path: target/

  dbt-run-dev:
    name: dbt Run (Dev Environment)
    runs-on: ubuntu-latest
    needs: dbt-test
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-snowflake
        pip install -r scripts/requirements.txt
    
    - name: Install dbt packages
      run: dbt deps
    
    - name: Create profiles.yml (Dev)
      run: |
        mkdir -p ~/.dbt
        cp profiles.yml.template ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_ACCOUNT}}/${{ secrets.SNOWFLAKE_ACCOUNT }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_USER}}/${{ secrets.SNOWFLAKE_USER }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_PASSWORD}}/${{ secrets.SNOWFLAKE_PASSWORD }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_DATABASE}}/${{ secrets.SNOWFLAKE_DATABASE }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_WAREHOUSE}}/${{ secrets.SNOWFLAKE_WAREHOUSE }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_ROLE}}/${{ secrets.SNOWFLAKE_ROLE }}/g" ~/.dbt/profiles.yml
    
    - name: Run dbt (Dev)
      run: |
        dbt run --select staging
        dbt run --select intermediate
        dbt run --select marts
      env:
        DBT_PROFILES_DIR: ./
        DBT_TARGET: dev
    
    - name: Run Great Expectations
      run: |
        python scripts/gx_run_checkpoint.py
      env:
        DBT_PROFILES_DIR: ./
      continue-on-error: true

  dbt-run-prod:
    name: dbt Run (Production)
    runs-on: ubuntu-latest
    needs: dbt-test
    if: github.ref == 'refs/heads/main'
    environment: production  # Requires manual approval
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install dbt-snowflake
        pip install -r scripts/requirements.txt
    
    - name: Install dbt packages
      run: dbt deps
    
    - name: Create profiles.yml (Prod)
      run: |
        mkdir -p ~/.dbt
        cp profiles.yml.template ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_ACCOUNT}}/${{ secrets.SNOWFLAKE_ACCOUNT }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_USER}}/${{ secrets.SNOWFLAKE_USER }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_PASSWORD}}/${{ secrets.SNOWFLAKE_PASSWORD }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_DATABASE}}/${{ secrets.SNOWFLAKE_DATABASE }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_WAREHOUSE}}/${{ secrets.SNOWFLAKE_WAREHOUSE }}/g" ~/.dbt/profiles.yml
        sed -i "s/{{SNOWFLAKE_ROLE}}/${{ secrets.SNOWFLAKE_ROLE }}/g" ~/.dbt/profiles.yml
    
    - name: Run dbt (Prod)
      run: |
        dbt run --select staging
        dbt run --select intermediate
        dbt run --select marts
      env:
        DBT_PROFILES_DIR: ./
        DBT_TARGET: prod
    
    - name: Run Great Expectations
      run: |
        python scripts/gx_run_checkpoint.py
      env:
        DBT_PROFILES_DIR: ./
      continue-on-error: true

